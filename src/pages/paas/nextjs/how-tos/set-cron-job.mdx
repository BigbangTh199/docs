import Layout from "@/components/Layout";
import Button from "@/components/Common/button";
import Section from "@/components/Common/section";
import Alert from "@/components/Common/alert";
import Tabs from "@/components/Common/tab";
import Step from "@/components/Common/step";
import Card from "@/components/Common/card";
import Important from "@/components/Common/important";
import Highlight from "react-highlight";
import Link from "next/link";
import NextPage from "@/components/Common/nextpage";

import Head from "next/head";

<Layout>
<Head>
<title>مستندات تنظیم Cron Job در NextJS - لیارا</title>
</Head>
# تنظیم Cron Job
<hr className="mb-2" />

Cron job یک وظیفه زمان‌بندی شده در سیستم‌عامل‌های Unix و Linux است که به کاربران اجازه می‌دهد تا اسکریپت‌ها یا دستورات را در فواصل زمانی منظم اجرا کنند. این ابزار به خصوص برای انجام وظایف دوره‌ای مثل پشتیبان‌گیری، ارسال ایمیل، اجرای اسکریپت‌های نگهداری سیستم، یا به‌روزرسانی اطلاعات مفید است.
<div className="h-4" />

برای تنظیم یک Cron Job در NextJS
کافیست تا در مسیر اصلی پروژه، یک فایل به نام <Important>liara.json</Important> ایجاد کنید و Cron Jobهای مد نظر خود را در
آرایه‌ای به نام <Important>cron</Important>، تنظیم و پیکربندی کنید. 
به عنوان مثال، 
فرض کنید که یک API به نام test با محتوای زیر دارید: 

<Tabs 
    tabs={["Pages Router", "App Router"]} 
    content={[
    <>
        <div dir="ltr">
          <Highlight  className="js">
          {`// pages/api/test.js

export default function handler(req, res) {
  console.log('this is a test');
  res.status(200).json({ message: 'API executed successfully' });
}
`}
          </Highlight>
        </ div>
    </>,
    <>
        <div dir="ltr">
          <Highlight  className="js">
          {`// app/api/test/route.js

export async function GET(request) {
  console.log('this is a test');
  return new Response(JSON.stringify({ message: 'API executed successfully' }), {
    status: 200,
    headers: {
      'Content-Type': 'application/json',
    },
  });
}
`}
          </Highlight>
        </ div>
    </>,
    ]}
/>

و یا اگر که از <a href="/paas/nextjs/how-tos/use-type-script/" className="text-[#2196f3]">TypeScript</a> استفاده می‌کنید؛ محتوای APIتان می‌تواند مانند زیر باشد: 

<Tabs 
    tabs={["Pages Router", "App Router"]} 
    content={[
    <>
        <div dir="ltr">
          <Highlight  className="ts">
          {`// pages/api/test.ts
import { NextApiRequest, NextApiResponse } from 'next';

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  console.log('this is a test');
  res.status(200).json({ message: 'API executed successfully' });
}
`}
          </Highlight>
        </ div>
    </>,
    <>
        <div dir="ltr">
          <Highlight  className="ts">
          {`// app/api/test/route.ts

import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  console.log('this is a test');
  return NextResponse.json({ message: 'API executed successfully' }, { status: 200 });
}
`}
          </Highlight>
        </ div>
    </>,
    ]}
/>

حال، برای اینکه API شما، مثلاً در هر دقیقه، به صورت خودکار اجرا شود؛ شما می‌توانید از قابلیت Cron Job استفاده کنید و در آرایه <Important>cron</Important> در فایل <Important>liara.json</Important>، قطعه کدی مشابه قطعه کد زیر، بنویسید:
<div className="h-2" />
<div dir="ltr">
<Highlight  className="json">
{`{
  "cron": [
    "* * * * * curl http://localhost:3000/api/test"
  ]
}`}
</Highlight>
</ div>
<div className="h-2" />
با انجام کار فوق و استقرار برنامه‌تان با <a href="/references/cli/about" className="text-[#2196f3]">Liara CLI</a> و دستور <Important>liara deploy</Important>، Cron Job در برنامه شما، تنظیم خواهد شد
و در زمان مشخص شده، برای‌تان اجرا می‌شود. 

<Section id="cron-format" title="فرمت زمان‌بندی Cron Job" />
در نظر داشته باشید که فرمت زمان‌بندی Cron به صورت زیر است:
<div className="h-2" />
<div dir="ltr">
<Highlight  className="scss">
{`* * * * *
│ │ │ │ │
│ │ │ │ └── روزهای هفته (۰-۷) (۰ و ۷ هر دو نشان‌دهنده یکشنبه هستند)
│ │ │ └──── ماه‌ها (۱-۱۲)
│ │ └────── روزهای ماه (۱-۳۱)
│ └──────── ساعت‌ها (۰-۲۳)
└────────── دقیقه‌ها (۰-۵۹)
`}
</Highlight>
</ div>
<div className="h-2" />

<Alert variant="success">
<p>
    با کمک <a href="https://crontab.guru/" className="text-[#2196f3] ">این</a> وب‌سایت، می‌توانید زمان دلخواه خود را، بسازید.
</p>
</Alert>


پس از تنظیم cron jobها و استقرار مجدد برنامه، می‌توانید لیست آن‌ها را در قسمت **تنظیمات برنامه** خود، مشاهده بفرمایید:
<div className="h-2" />
<img src="https://files.liara.ir/liara/docs/see-cron-jobs.png" alt="see cron jobs on liara" />

<Section id="create-backup" title="تهیه فایل پشتیبان از سورس‌کد" />
شما می‌توانید با تنظیم Cron Job، یک API Endpoint برای ایجاد فایل پشتیبان از سورس کد خود؛ بسازید
به عنوان مثال، می‌توانید این کار را با پکیج <Important>archiver</Important>، انجام دهید. در ابتدا، کافیست تا با اجرای دستور زیر 
در Local، این پکیج را نصب کنید:

<div className="h-2" />
<div dir="ltr">
<Highlight  className="bash">
{`npm install archiver`}
</Highlight>
</ div>
<div className="h-2" />
 
در ادامه، می‌توانید یک API جدید ایجاد کنید و قطعه کد زیر را در آن، قرار دهید:

<Tabs 
    tabs={["Pages Router", "App Router"]} 
    content={[
    <>
        <div dir="ltr">
          <Highlight  className="js">
          {`// pages/api/backup.js

import archiver from 'archiver';
import path from 'path';
import fs from 'fs';

export default function handler(req, res) {
  const backupDir = path.join(process.cwd(), 'backups'); // مسیر دایرکتوری بکاپ
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir);
  }

  const backupFileName = \`backup_\${Date.now()}.zip\`;
  const backupFilePath = path.join(backupDir, backupFileName);

  const output = fs.createWriteStream(backupFilePath);
  const archive = archiver('zip', { zlib: { level: 9 } });

  output.on('close', () => {
    console.log(\`Backup created at: \${backupFilePath}\`);
    res.status(200).json({ message: \`Backup created at: \${backupFilePath}\` });
  });

  archive.on('error', (err) => {
    throw err;
  });

  archive.pipe(output);

  archive.glob('**/*', {
    cwd: process.cwd(),
    ignore: ['node_modules/**', '.next/**', 'backups/**'],
  });

  archive.finalize();
}
`}
          </Highlight>
        </ div>
    </>,
    <>
        <div dir="ltr">
          <Highlight  className="js">
          {`// app/api/backup/route.js

import archiver from 'archiver';
import path from 'path';
import fs from 'fs';

export async function GET(req) {
  const backupDir = path.join(process.cwd(), 'backups'); // مسیر دایرکتوری بکاپ
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir);
  }

  const backupFileName = \`backup_\${Date.now()}.zip\`;
  const backupFilePath = path.join(backupDir, backupFileName);

  const output = fs.createWriteStream(backupFilePath);
  const archive = archiver('zip', { zlib: { level: 9 } });

  await new Promise((resolve, reject) => {
    output.on('close', () => {
      console.log(\`Backup created at: \${backupFilePath}\`);
      resolve();
    });

    archive.on('error', (err) => {
      reject(err);
    });

    archive.pipe(output);

    archive.glob('**/*', {
      cwd: process.cwd(),
      ignore: ['node_modules/**', '.next/**', 'backups/**'],
    });

    archive.finalize();
  });

  return new Response(JSON.stringify({ message: \`Backup created at: \${backupFilePath}\` }), {
    status: 200,
    headers: {
      'Content-Type': 'application/json',
    },
  });
}
`}
          </Highlight>
        </ div>
    </>,
    ]}
/>

و یا اگر که از TypeScript استفاده می‌کنید؛ قطعه کد زیر را، قرار دهید:

<Tabs 
    tabs={["Pages Router", "App Router"]} 
    content={[
    <>
        <div dir="ltr">
          <Highlight  className="ts">
          {`// pages/api/backup.ts

import archiver from 'archiver';
import path from 'path';
import fs from 'fs';
import { NextApiRequest, NextApiResponse } from 'next';

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const backupDir = path.join(process.cwd(), 'backups'); // مسیر دایرکتوری بکاپ
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir);
  }

  const backupFileName = \`backup_\${Date.now()}.zip\`;
  const backupFilePath = path.join(backupDir, backupFileName);

  const output = fs.createWriteStream(backupFilePath);
  const archive = archiver('zip', { zlib: { level: 9 } });

  output.on('close', () => {
    console.log(\`Backup created at: \${backupFilePath}\`);
    res.status(200).json({ message: \`Backup created at: \${backupFilePath}\` });
  });

  archive.on('error', (err) => {
    throw err;
  });

  archive.pipe(output);

  archive.glob('**/*', {
    cwd: process.cwd(),
    ignore: ['node_modules/**', '.next/**', 'backups/**'],
  });

  archive.finalize();
}
`}
          </Highlight>
        </ div>
    </>,
    <>
        <div dir="ltr">
          <Highlight  className="ts">
          {`// app/api/backup/route.ts

import archiver from 'archiver';
import path from 'path';
import fs from 'fs';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(req: NextRequest) {
  const backupDir = path.join(process.cwd(), 'backups'); // مسیر دایرکتوری بکاپ
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir);
  }

  const backupFileName = \`backup_\${Date.now()}.zip\`;
  const backupFilePath = path.join(backupDir, backupFileName);

  const output = fs.createWriteStream(backupFilePath);
  const archive = archiver('zip', { zlib: { level: 9 } });

  await new Promise<void>((resolve, reject) => {
    output.on('close', () => {
      console.log(\`Backup created at: \${backupFilePath}\`);
      resolve();
    });

    archive.on('error', (err) => {
      reject(err);
    });

    archive.pipe(output);

    archive.glob('**/*', {
      cwd: process.cwd(),
      ignore: ['node_modules/**', '.next/**', 'backups/**'],
    });

    archive.finalize();
  });

  return NextResponse.json({ message: \`Backup created at: \${backupFilePath}\` });
}
`}
          </Highlight>
        </ div>
    </>,
    ]}
/>

در نهایت، با تنظیم Cron Job مانند شکل زیر در فایل <Important>liara.json</Important>، می‌توانید در هر 24 ساعت، از سورس کد خود، به صورت خودکار، یک فایل پشتیبان داشته باشید:

<div className="h-2" />
<div dir="ltr">
<Highlight  className="json">
{`{
  "cron": [
    "0 0 * * * curl http://localhost:3000/api/backup"
  ]
}`}
</Highlight>
</ div>
<div className="h-2" />

<Alert variant="success">
<p>
بهتر است که برای ذخیره فایل‌های بکاپ، از APIهای third-party استفاده کنید تا در صورت بروز مشکل در پروژه، بتوانید دسترسی داشته و از آن، استفاده کنید.
</p>
</Alert>

</Layout>