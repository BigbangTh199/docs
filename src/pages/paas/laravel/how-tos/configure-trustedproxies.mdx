import Layout from "@/components/Layout";
import Button from "@/components/Common/button";
import Section from "@/components/Common/section";
import Alert from "@/components/Common/alert";
import Tabs from "@/components/Common/tab";
import Step from "@/components/Common/step";
import Card from "@/components/Common/card";
import Important from "@/components/Common/important";
import Highlight from "react-highlight";
import Link from "next/link";
import NextPage from "@/components/Common/nextpage";

<Layout>
# پیکربندی TrustedProxies در Laravel
<hr className="mb-2" />

با توجه به این نکته که تمامی درخواست‌ها توسط <a href="../../../details/reverse-proxy" className="blue-link">reverse proxy</a> لیارا به برنامه‌ی شما هدایت می‌شود؛ باید در زمان استفاده از فریم‌ورک‌های مختلف برای مشاهده‌ی IP واقعی کاربران و بسیاری از قابلیت‌های دیگر تعیین کنید که برنامه‌ی شما در پشت یک reverse proxy راه‌اندازی شده است.

<div className="h-2" />
عبارت Trusted Proxies یا پروکسی‌های مورد اعتماد، به پروکسی‌هایی گفته می‌شود که سرور به آنها اعتماد دارد تا آدرس‌های IP واقعی کاربران را ارسال کنند. در بسیاری از مواقع، سرورهایی که پشت یک پروکسی معکوس (reverse proxy) قرار دارند، فقط آدرس IP پروکسی را می‌بینند و نه آدرس IP واقعی کاربران. برای رفع این مشکل و برای دلایلی مانند رهگیری، ردیابی یا اعمال سیاست‌های امنیتی، TrustedProxyها، IP واقعی کاربران را از طریق هدرهای HTTP خاصی مثل X-Forwarded-For یا X-Real-IP به سرورهای پشتی ارسال می‌کنند.
<div className="h-2" />
<div className='h-2' />
<img src="https://files.liara.ir/liara/docs/how-trusted-proxy-works.png" alt="how trusted proxy works" />
<div className='h-2' />

برای این که در برنامه‌ی‌تان بتوانید به آی‌پی واقعی کاربر دسترسی داشته باشید و یا این که از قابلیت Signed URLهای Laravel استفاده کنید، لازم است که تغییراتی را در فایل <Important>app/Http/Middleware/TrustProxies.php</Important> اعمال کنید.


<div dir='ltr'>
        <Highlight className="bash">
            {`LOG_CHANNEL=daily`}
        </Highlight>
    </div>
    <div className="h-2" />

<div className="h-2" />

<Section id="manage-logs-using-multiple-drivers" title="مدیریت لاگ‌ها با چند درایور" />

شما می‌توانید با استفاده از درایور <Important>stack</Important>، از چند درایور به صورت همزمان، برای مدیریت لاگ‌ها، استفاده کنید. به عنوان مثال، فرض کنید که قصد دارید هم لاگ‌ها را در ترمینال ببینید و هم آن‌ها را روزانه، در فایل‌های مجزا، ذخیره کنید؛ برای این‌کار کافیست تا در ابتدا، طبق 
<a href="../../details/envs" className="blue-link">مستندات تنظیم متغیرهای محیطی</a>، متغیر <Important>LOG_CHANNEL</Important> را به شکل زیر، تغییر دهید:
<div className="h-2" />
<div dir='ltr'>
        <Highlight className="bash">
            {`LOG_CHANNEL=stack`}
        </Highlight>
    </div>
    <div className="h-2" />

در ادامه، کافیست تا در فایل <Important>config/logging.php</Important>، فیلد <Important>channels</Important> آرایه <Important>stack</Important> را، به شکل زیر، تغییر دهید:
<div className="h-2" />
<div dir='ltr'>
        <Highlight className="php">
            {`return [

    'channels' => [

        'stack' => [
            'driver' => 'stack',
            'channels' => ['errorlog', 'daily'],
            'ignore_exceptions' => false,
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => env('LOG_DAILY_DAYS', 14),
            'replace_placeholders' => true,
        ],

        'errorlog' => [
            'driver' => 'errorlog',
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],
    ],

];`}
        </Highlight>
    </div>
    <div className="h-2" />
در نهایت، با استقرار مجدد برنامه، تغییرات مدنظرتان، ذخیره خواهد شد.

<Alert variant="success">
<p>
می‌توانید برای اطلاعات بیشتر، به <a href="https://laravel.com/docs/master/logging#building-log-stacks" className="blue-link">مستندات رسمی لاراول</a> مراجعه کنید.
</p>
</Alert>

<NextPage next="./configure-trustedproxies"/>
</Layout>